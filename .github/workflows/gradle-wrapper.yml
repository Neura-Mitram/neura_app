name: 🔧 Gradle Wrapper Generator

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  generate-wrapper:
    runs-on: ubuntu-latest
    name: 🔨 Generate Gradle Wrapper

    permissions:        # ✅ Needed for GITHUB_TOKEN push
      contents: write

    steps:
      - name: 🧾 Checkout Code
        uses: actions/checkout@v4

      - name: 🔒 Fail if on protected branch
        if: github.ref == 'refs/heads/main'
        run: |
          echo "❌ Cannot run this on 'main'. Switch to 'dev' or another branch."
          exit 1

      - name: 🧪 Check if Gradle wrapper already exists
        id: check-wrapper
        run: |
          if [ -f "./android/gradlew" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: 🔁 Temporarily replace settings.gradle.kts
        if: steps.check-wrapper.outputs.exists == 'false'
        working-directory: android
        run: |
          cp settings.gradle.kts settings.gradle.kts.bak
          echo 'rootProject.name = "temp"' > settings.gradle.kts

      - name: 🧰 Generate Gradle wrapper using init
        if: steps.check-wrapper.outputs.exists == 'false'
        working-directory: android
        run: |
          curl -s -o gradle-8.5-bin.zip https://services.gradle.org/distributions/gradle-8.5-bin.zip
          unzip gradle-8.5-bin.zip
          ./gradle-8.5/bin/gradle wrapper --gradle-version 8.5
          # Copy wrapper jar manually
          cp gradle-8.5/gradle/wrapper/gradle-wrapper.jar gradle/wrapper/
          rm -rf gradle-8.5 gradle-8.5-bin.zip

      - name: ♻️ Restore original settings.gradle.kts
        if: steps.check-wrapper.outputs.exists == 'false'
        working-directory: android
        run: |
          mv settings.gradle.kts.bak settings.gradle.kts

      - name: 🚀 Commit & Push Gradle wrapper to `dev` branch
        if: steps.check-wrapper.outputs.exists == 'false'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -B dev || git checkout dev
          git add android/gradle/wrapper/gradle-wrapper.jar android/gradle/wrapper/gradle-wrapper.properties android/gradlew android/gradlew.bat
          git commit -m "🔧 Generate Gradle wrapper files via GitHub Actions"
          git push origin dev

      - name: ✅ Done or Already Exists
        if: steps.check-wrapper.outputs.exists == 'true'
        run: echo "✔️ Gradle wrapper already exists. Nothing to do."
