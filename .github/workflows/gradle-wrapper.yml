name: ğŸ”§ Gradle Wrapper Generator

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  generate-wrapper:
    runs-on: ubuntu-latest
    name: ğŸ”¨ Generate Gradle Wrapper

    permissions:        # âœ… Needed for GITHUB_TOKEN push
      contents: write

    steps:
      - name: ğŸ§¾ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”’ Fail if on protected branch
        if: github.ref == 'refs/heads/main'
        run: |
          echo "âŒ Cannot run this on 'main'. Switch to 'dev' or another branch."
          exit 1

      - name: ğŸ§ª Check if full Gradle wrapper exists
        id: check-wrapper
        run: |
          if [ -f "./android/gradlew" ] && \
             [ -f "./android/gradlew.bat" ] && \
             [ -f "./android/gradle/wrapper/gradle-wrapper.jar" ] && \
             [ -f "./android/gradle/wrapper/gradle-wrapper.properties" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Temporarily replace settings.gradle.kts
        if: steps.check-wrapper.outputs.exists == 'false'
        working-directory: android
        run: |
          cp settings.gradle.kts settings.gradle.kts.bak
          echo 'rootProject.name = "temp"' > settings.gradle.kts

      - name: ğŸ§° Generate Gradle wrapper manually
        if: steps.check-wrapper.outputs.exists == 'false'
        working-directory: android
        run: |
          curl -s -o gradle-8.5-bin.zip https://services.gradle.org/distributions/gradle-8.5-bin.zip
          unzip gradle-8.5-bin.zip
          ./gradle-8.5/bin/gradle wrapper --gradle-version 8.5
          # Manually copy wrapper jar in case it's not copied
          cp gradle-8.5/gradle/wrapper/gradle-wrapper.jar gradle/wrapper/
          rm -rf gradle-8.5 gradle-8.5-bin.zip

      - name: â™»ï¸ Restore original settings.gradle.kts
        if: steps.check-wrapper.outputs.exists == 'false'
        working-directory: android
        run: |
          mv settings.gradle.kts.bak settings.gradle.kts

      - name: ğŸš€ Commit & Push Gradle wrapper to `dev` branch
        if: steps.check-wrapper.outputs.exists == 'false'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -B dev || git checkout dev
          git add android/gradle/wrapper/gradle-wrapper.jar android/gradle/wrapper/gradle-wrapper.properties android/gradlew android/gradlew.bat
          git commit -m "ğŸ”§ Generate Gradle wrapper files via GitHub Actions"
          git push origin dev

      - name: âœ… Done or Already Exists
        if: steps.check-wrapper.outputs.exists == 'true'
        run: echo "âœ”ï¸ Full Gradle wrapper already exists. Nothing to do."
